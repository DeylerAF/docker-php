version: "3.8"
# Define the network
networks:
    local-network:
        driver: bridge # Use the bridge driver
        ipam:
            config:
                - subnet: 172.16.238.0/24 # Use the IP range 172.16.238.0/24
# Define the services
services:
    # Define the database service
    db:
        image: mysql:latest # Use the MySQL image
        container_name: msql_db
        restart: always # Always restart the container if it stops
        ports:
            - "${DB_PORT}:${DB_PORT}" # Map the port on the host to the port on the container
        volumes:
            - ./db:/var/lib/mysql:delegated # Mount the volume to persist data
            # - ./conf/mysql/conf/my.cnf:/etc/my.cnf # Mount the configuration file
        command:
            - "--default-authentication-plugin=mysql_native_password" # Set the default authentication plugin for the database
            - "--port=${DB_PORT}" # Set the default port for the database
            - "--character-set-server=utf8mb4" # Set the default character set for the database
            - "--collation-server=utf8mb4_unicode_ci" # Set the default collation for the database
        environment:
            TZ: "UTC" # Set the default time zone for the database
            MYSQL_ROOT_PASSWORD: ${DB_PASSWORD} # Set the root password for the database
            MYSQL_DATABASE: database # Create a new database for the application
            MYSQL_USER: myuser # Create a new non-root user for the database
            MYSQL_PASSWORD: myuserpassword # Set a password for the new user
            MYSQL_TCP_PORT: ${DB_PORT} # Set the default port for the database
            # MYSQL_RANDOM_ROOT_PASSWORD: "1"
        networks:
            local-network:

    # Define the phpMyAdmin service
    phpmyadmin:
        image: phpmyadmin/phpmyadmin:latest # Use the latest phpMyAdmin image
        container_name: pma
        restart: always # Always restart the container if it stops
        environment:
            PMA_HOST: db # Set the database host for phpMyAdmin
            MYSQL_ROOT_PASSWORD: ${DB_PASSWORD} # Set the root password for the database
        ports:
            - "8181:80" # Map port 8181 on the host to port 80 on the container
        depends_on:
            - db # Depend on the database service
        networks:
            local-network:

    # Define the app service
    app:
        build:
            context: ./
            dockerfile: Dockerfile # Use the specified Dockerfile for building the image
        container_name: app
        restart: always # Always restart the container if it stops
        depends_on:
            - db # Depend on the database service
        ports:
            - "80:80" # Map port 8080 on the host to port 80 on the container
            - "443:443"
        volumes:
            - ./app:/var/www/html # Mount the volume to share the code
            - ./conf/php:/usr/local/etc/php # Mount the php configuration
            # - ./conf/apache2:/etc/apache2 # Mount your Apache configuration file
        networks:
            local-network:

# Define the volumes
volumes:
    db: {} # Define the volume to persist database data
    app: {} # Define the volume to share the code
    conf: {} # Define the volume to share the php configuration
